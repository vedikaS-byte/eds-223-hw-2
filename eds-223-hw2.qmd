---
title: "eds-223-hw2"
format: html
editor: 
  markdown: 
    wrap: 72
editor_options: 
  chunk_output_type: console
---

# Exploring Patterns of Environmental Justice in Los Angeles County
Primary Objective
With an estimated 9.8 million residents in 2023, Los Angeles County is the most populous county in California and the entire United States (https://datausa.io/profile/geo/los-angeles-county-ca). Los Angeles County is also racially diverse: there are about 2.48 million White (Non-Hispanic) residents, 
In 2023, there were 1.09 times more White (Non-Hispanic) residents (2.48M people) in Los Angeles County, CA than any other race or ethnicity. There were 2.26M Other (Hispanic) and 1.46M Asian (Non-Hispanic) residents, the second and third most common ethnic groups.

The goal of this analysis is to assess the impacts of historical redlining on communities and biodiversity in Los Angeles (LA). 

## Load the appropriate packages
```{r}
#| include: false
# Import libraries
library(sf)
library(here)
library(tidyverse)
library(ggplot2)
library(tmap)
library(kableExtra)
```

## Importing Data 
1. Import the geodatabase of EJ Screen data, the shapefile of bird observations, and the json file of HOLC redlining neighborhoods in LA.

```{r}
#| output: false
# Load in the data
ej_screen <- st_read(here::here("data","ejscreen", "EJSCREEN_2023_BG_StatePct_with_AS_CNMI_GU_VI.gdb"))
birds <- st_read(here::here("data","gbif-birds-LA", "gbif-birds-LA.shp"))
inequal <- st_read(here::here("data","mapping-inequality", "mapping-inequality-los-angeles.json"))
```

## Part 1: Legacy of Redlining in Current Environmental Injustice

Your first task is to explore historical redlining in Los Angeles and
its legacy on present-day environmental justice.

Description 
For this assignment, you must complete the following:

1. Create a map of historical redlining neighborhoods, including:
- neighborhoods colored by HOLC grade an appropriate base map 
- a clear title and legend 


```{r}
# Check CRS for all
st_crs(ej_screen) # WGS 84 / Pseudo-Mercator 
st_crs(birds)  # WGS 84 
st_crs(inequal) # WGS 84 

# Transform to match same CRS as ej_screen
birds <- st_transform(birds, st_crs(ej_screen))
inequal <- st_transform(inequal, st_crs(ej_screen))
```

### Map of Historical Redlining in Los Angeles (HOLC)

```{r}
# Create a map of historical redlining neighborhoods, including:
# - neighborhoods colored by HOLC grade 
# - an appropriate base map 
# - a clear title and legend 
map1 <- tm_shape(inequal) +
  tm_tiles("CartoDB.Positron") + #Establish a basemap with tm_tiles using a view from https://leaflet-extras.github.io/leaflet-providers/preview/
  tm_polygons(
    col = "grade",
    palette = "brewer.Reds",
    alpha = 0.7,                      
    border.col = "black",
    title = "HOLC Grade")   +
  tm_compass(position = c("left", "top")) +
  tm_scalebar(position = c("left", "bottom")) +
  tm_graticules() +
  tm_layout(
    main.title = "Historical Redlining in Los Angeles (HOLC)", 
    title.size = 1,
    #outer.margins = c(0.1, 0.05, 0.05, 0.05),
    legend.outside = TRUE,
    legend.outside.position = "right",
    component.autoscale = FALSE
  )

map1

tmap_save(map1, "figs/LA_HOC.png")

```

### Summary Table of Census Block Groups Inside or Outside HOLC Grade
_. 
2. Create a table summarizing: 
- the percentage of census block groups that fall within each HOLC grade 
- Also include the percent of census block groups that don’t fall within a HOLC grade 
- Hint: The HOLC data contains the grades and the EJScreen data contains the census
blocks, so you will need to combine the data spatially before doing
summary statistics. Once you combine and no longer need the geometries,
you can use st_drop_geometry(). 

```{r}
#  Hint: The HOLC data contains the grades and the EJScreen data contains the census
# blocks, so you will need to combine the data spatially before doing
# summary statistics. Once you combine and no longer need the geometries,
# you can use st_drop_geometry(). 
str(ej_screen)
str(inequal)

# thought process: 
# first, need to combine data spatially via spatial join (left to keep observations in x + observations in y that are found in x), then drop geoms...  assign HOLC grade to each census block

# Filter for observations within LA county, not the whole country
ej_la <- ej_screen %>% filter(STATE_NAME == "California", CNTY_NAME == "Los Angeles County") # Keep all LA census blocks and not just ones that intersect HOLC polygons

# st_join() performs spatial join between spatial objects
# ej_la is census block data for Los Angeles County
# inequal  is  HOLC (redlining) polygon layer
# assign to each census block from ej_la the HOLC grade from  HOLC polygons (inequal) that spatially overlap it
# default spatial predicate is st_intersects (any block that touches or overlaps a HOLC polygon gets matched)
# left = T: keep all features from ej_la even if do not intersect any HOLC polygon
# for those outside HOLC boundaries the HOLC columns (like grade) will be NA

# default spatial predicate is st_intersects meaning any block that touches or overlaps a HOLC polygon gets matched

census_holc <- st_join(ej_la, inequal, left = T)
census_holc_df <- st_drop_geometry(census_holc)

census_summary <- census_holc_df %>%
  mutate(grade = ifelse(is.na(grade), "No HOLC grade", grade)) %>% 
  group_by(grade) %>% summarise(count = n())%>% # count # of rows in each grade group
  mutate(percent = round(100 * count / sum(count), 2)) # create a new variable to calculate the percent of how much each grade over the total observations represents

census_summary %>% 
  kbl() %>%
  kable_styling() # https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html 


```




3. Create at least two visualizations summarizing current conditions (from the EJScreen data) within HOLC grades using the mean of the following variables (you may combine
variables or create separate plots): 

- % low income 
- percentile for Particulate Matter 2.5 
- percentile for low life expectancy 
-Use ggplot for your visualizations! You will first need to calculate mean of each variable grouped by HOLC grade. 

```{r}
holc_summary <- census_holc_df %>%
  group_by(grade) %>% 
  mutate(grade = ifelse(is.na(grade), "No HOLC grade", grade)) %>%
  filter(grade != "No HOLC grade") %>%
  summarise(
    mean_low_income = mean(P_LOWINCPCT, na.rm = TRUE),
    mean_pm25 = mean(P_PM25, na.rm = TRUE),
    mean_low_life_exp = mean(P_LIFEEXPPCT, na.rm = TRUE)
  ) %>%
  pivot_longer(
    cols = starts_with("mean_"),
    names_to = "socio_economic",
    values_to = "mean_value"
  ) 

# bar plot: mean value for each variable by HOLC grade
holc_summary %>% ggplot(aes(x = grade, y = mean_value, fill = grade)) +
  geom_col() +
  facet_wrap(~ socio_economic, scales = "free_y") +
  labs(
    x = "HOLC Grade",
    y = "Mean Value",
    title = "Mean EJScreen Indicators by HOLC Grade"
  ) +
  theme_bw() + 
  theme(legend.position = "none") 

# 
ggplot(holc_summary, aes(x = grade, y = mean_value, color = grade)) +
  geom_point(size = 3) +
  facet_wrap(~ variable, scales = "free_y") +
  labs(
    x = "HOLC Grade",
    y = "Mean Value",
    title = "Mean EJScreen Indicators by HOLC Grade"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```


Write a brief paragraph reflecting on these results. Interpret the patterns you observe in your results. Discuss potential relationships between historical redlining grades and current
environmental/socioeconomic conditions. 




## Part 2: Legacy of redlining in biodiversity observations

Description
For this assignment, you must produce the following based on observations from 2021-2023:

1. A figure summarizing the percent of bird observations within redlined neighborhoods within each HOLC grade

Create a visualizations that shows:
- The percentage of bird observations within each HOLC grade
```{r}
# Ensure in same CRS! 
st_crs(birds) == st_crs(inequal) # Yes they match 


# Perform spatial join to assign each bird observation to a HOLC grade polygon
# st_intersects so points on borders are included in spatial 
birds_holc <- st_join(birds, inequal, join = st_intersects, left = FALSE)

# Summarize % of bird observations by HOLC grade
bird_summary <- birds_holc %>%
  st_drop_geometry() %>% #
  group_by(grade) %>%
  summarise(count = n()) %>%
  mutate(percent = round(100 * (count / sum(count)), 2),
         grade = factor(grade, levels = c("A","B","C","D"))) %>%
  arrange(grade)

print(bird_summary)

# creat a pallete for each grade (percent of bird observations per HOLC grade)
grade_colors <- c("A" = "#2ca25f",
                  "B" = "#99d8c9",
                  "C" = "#fec44f",
                  "D" = "#de2d26")

bird_summary %>% ggplot(aes(x = grade, y = percent, fill = grade)) +
  geom_col(width = 0.7) +
  geom_text(aes(label = paste0(percent, "%")), vjust = -0.5, size = 3.5) +
  scale_fill_manual(values = grade_colors) +
  labs(
    title = "Percent of Bird Observations (2021–2023) within HOLC Grades",
    x = "HOLC Grade",
    y = "Percent of Bird Observations",
    caption = "Bird observations within Los Angeles HOLC neighborhoods (2021–2023)."
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))



```


- Include an appropiate title, axis labels, and legend
- Hints: Ensure the bird observations and HOLC dataset have matching CRS’, then perform a spatial join to assign each bird observations to a corresponding HOLC grade.
- Spolier alert!! Our results don’t match the findings from Ellis-Soto et al. 2023! Read the abstract of the study. Why might we have obtained different results in our analysis? What did the paper consider that we did not?








